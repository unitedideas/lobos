{% extends "base.html" %}
{% load static %}

<head>

    {# jQuery #}
    <script type="text/javascript" src="{% static "events/add_form_script.js" %}"></script>
    {# Vue.js CDN #}
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- jQuery for PayPal -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>


</head>
{% block body %}
    <div id="app">
        <div class=container>
            <div class="jumbotron">
                <h1>{{ event }}</h1>
                <p>A little history about the event here</p>
                <p>Maybe a notice</p>
                <p>Date</p>
                <p>Location</p>

            </div>
            <div class="container">
                <div class="row">
                    <div class="col-sm-8 col-md-8 col-lg-8">
                        <form class="form-horizontal" method="POST" action="">
                            {% csrf_token %}
                            {{ formset.management_form }}
                            <div style=" padding: 20px 60px 20px 60px; margin-right: 15px;"
                                 class="row form-row">
                                <div class="input-group">
                                    <div v-for="form in formList">
                                        <br>
                                        <div style="background-color: #ffe673; padding: 20px" v-html="form">
                                        </div>
                                    </div>
                                    <div style="padding-left: 60px; background-color: black">
                                        <p v-on:click="addForm" class="btn btn-primary btn-lg">Add Form</p>
                                        <p v-on:click="formID" class="btn btn-primary btn-lg">Delete Form</p>
                                    </div>
                                    <br>
                                    <br>
                                </div>
                            </div>
                            <div style="padding-left: 60px; background-color: black">
                                <button type="submit" class="btn btn-primary btn-lg">Finish Registration</button>
                                <div class="btn btn-primary btn-lg">
                                    <paypal-checkout
                                            :amount='amountStr'
                                            currency="USD"
                                            :button-style="aStyle"
                                            :client="paypal"
                                            env="sandbox"
                                            v-on:payment-authorized="paymentAuthorized"
                                            v-on:payment-completed="paymentCompleted"
                                            v-on:payment-cancelled="paymentCancelled">
                                    </paypal-checkout>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="col-sm-offset-7 col-sm-5 col-md-5 col-lg-4"
                         style="position: fixed; top: 520px; left: 100px; width: auto;">
                        <div>
                            <h3>Total Price:</h3>
                            <h3>$ [[amountInt]]</h3>
                            <br>
                            <paypal-checkout
                                    :amount="amountStr"
                                    currency="USD"
                                    :button-style="aStyle"
                                    :client="paypal"
                                    env="sandbox"
                                    v-on:payment-authorized="paymentAuthorized"
                                    v-on:payment-completed="paymentCompleted"
                                    v-on:payment-cancelled="paymentCancelled">
                            </paypal-checkout>
                            <br>
                        </div>
                    </div>
                    <br>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue-paypal-checkout/dist/vue-paypal-checkout.min.js"></script>
    <script>

        new Vue({
            delimiters: ['[[', ']]'],
            el: '#app',
            data() {
                return {
                    paypal: {
                        sandbox: 'Ab1Sz1kGg_pToL-VqcaNqUh1C4obLl11btkrD3nShf8FadP5sDn47sNiLVA7mHeWQKN9Fn14tMorYSag',
                        production: 'Aa2EMwpfZC-RkwuYd5FjEsuw5XOkYVmTk3K4GTJ1kTcMTuC5J2yV0mjhlua6mJg7Uf26YzPrMaCcixPT'
                    },
                    aStyle: {
                        label: 'checkout',
                        size: 'responsive',
                        shape: 'pill',
                        color: 'blue',
                        tagline: 'false'
                    },

                    {#paypalItems:[#}
                    {#    {#}
                    {#        'name': this.#}
                    {#    }#}
                    {#],#}
                    escortCost: 10.00,
                    escortRider: 'False',
                    riderCost: 70.00,
                    rider: 'True',
                    amountStr: '1.00',
                    amountInt: 1.00,
                    formList: [],
                    count: 0,
                    vue_form: "",
                    allRiderTypes: [],

                }
            },
            methods:
                {

                    addEscortForm: function () {
                        this.count++
                        let total_forms = document.getElementById('id_form-TOTAL_FORMS')
                        total_forms.value = this.count + 1
                        console.log(this.count)
                    },

                    addForm: function () {
                        this.count++
                        let form_count = this.count
                        form_count++

                        let formID = 'id_form-' + this.count
                        incremented_form = this.vue_form.replace(/form-\d/g, 'form-' + this.count)
                        this.formList.push(incremented_form)
                        this.$nextTick(() => {
                            let total_forms = document.getElementsByName('form-TOTAL_FORMS').forEach
                            (function (ele, idx) {
                                ele.value = form_count
                            })
                        })
                    },

                    delForm: function () {
                        if (this.count != 0) {
                            this.count--
                            let form_count = this.count
                            form_count++

                            let formID = 'id_form-' + this.count
                            this.formList.pop()
                            this.$nextTick(() => {
                                let total_forms = document.getElementsByName('form-TOTAL_FORMS').forEach
                                (function (ele, idx) {
                                    ele.value = form_count
                                })
                            })
                        }
                        else return
                    },

                    formID: function () {
                        let formID = 'id_form-' + this.count
                        console.log(formID)
                        this.delForm()
                    },

                    add_rider_type: function () {
                        console.log('in the foo')
                        this.paypalItems.push({"name": ""})
                        console.log(this.paypalItems)
                    },

                    paymentAuthorized: function (data) {
                        console.log('The payment was approved, make the button available')
                        console.log(data);
                    },
                    paymentCompleted: function (data) {
                        console.log('The payment was declined or cancled, please try again')
                        console.log(data);
                    },
                    paymentCancelled: function (data) {
                        console.log('The payment was declined or cancled, please try again')
                        console.log(data);
                    },

                },


            mounted:

                function () {
                    let app = this
                    console.log('In the mounted function')

                    axios.post("{% url 'event_formset' %}",
                        {processData: false, contentType: false},
                        {
                            headers:
                                {
                                    'X-CSRFToken': '{{ csrf_token }}',
                                }
                        })

                        .then(function (response) {
                            app.vue_form = response.data.formset
                            {#injected_form = app.vue_form.replace(/rider_class" /g, 'rider_class" @change="add_rider_type"')#}
                            app.formList.push(app.vue_form)
                        })
                },
        })

    </script>

{% endblock %}

