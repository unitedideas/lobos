{% extends "base.html" %}
{% load static %}

<head>
    {# jQuery #}
    <script type="text/javascript" src="{% static "events/JS.js" %}"></script>
    {# Vue.js CDN #}
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- jQuery for PayPal -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    {% block head %}
        <title>Event Registration</title>
    {% endblock %}
</head>

{% block body %}
    <div id="app">
        <div class="header row" id="myHeader">

            <h3>Total Price: $[[amountStr]]</h3>
            <div v-show="formIsValid === 'False'">
                <div v-on:click="the3DayMethod" class="btn btn-lg btn-primary" value="Check for Errors">Checkout</div>
            </div>
            <br>
            <div v-if="formSuccess === 'False'" class="p-3 mb-2 bg-danger text-white">
                <h3>Please correct these errors:</h3>
                <div id="v-for-formerrors">
                    <div v-for="(value, index, key) in formerrors">
                        <h4>Rider Form: [[key]] [[ ++index ]] - [[value]]</h4>
                    </div>
                </div>
            </div>
            <div v-show="formSuccess === 'True' && paymentComplete === 'False'">
                <div class="alert alert-success" role="alert">There are no errors proceed with payment</div>
                <div class="alert alert-warning" role="alert" v-show="payment_cancelled === 'True'">The payment was declined or canceled</div>
                <paypal-checkout
                        :amount='amountStr'
                        currency="USD"
                        :button-style="aStyle"
                        :client="paypal"
                        env="sandbox"
                        v-on:payment-authorized="paymentAuthorized"
                        v-on:payment-completed="paymentCompleted"
                        v-on:payment-cancelled="paymentCancelled">
                </paypal-checkout>
            </div>
            <button v-show="paymentComplete === 'True'" class="btn btn-primary btn-lg">Finalize Registration!</button>
        </div>
        <br>

        <div class="container">


            <div id="jumbotron" class="jumbotron" style="padding: 20px">
                <h1>{{ event }}</h1>
                <p>A little history about the event here</p>
                <p>Maybe a notice</p>
                <p>Date</p>
                <p>Location</p>
            </div>
            <div id="log"></div>
            <div class="container">
                <div>
                    <div>
                        <form method="POST" id="feedbackform">
                            {% csrf_token %}
                            {{ formset.management_form }}
                            <div style=" margin-right: 15px;"
                                 class="row form-row">
                                <div class="input-group">
                                    <div v-for="form in formList">

                                        <br>
                                        <div style="background-color: #ffe673; padding: 20px; border-radius:5px" v-html="form">
                                        </div>
                                    </div>
                                    <br>
                                    <div class="container">
                                        <span v-on:click="addForm" class="btn btn-primary btn-lg">Add Form</span>
                                        <span v-on:click="formID" class="btn btn-primary btn-lg">Delete Form</span>
                                    </div>
                                    <br>
                                </div>
                            </div>

                        </form>
                        <button id="show-modal" @click="showModal = true">Show Modal</button>
                        <!-- use the modal component, pass in the prop -->
                        <modal v-if="showModal" @close="showModal = false">
                            <!--
                              you can use custom content here to overwrite
                              default content
                            -->
                            <h3 slot="header">custom header</h3>
                        </modal>

                    </div>
                    <br>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue-paypal-checkout/dist/vue-paypal-checkout.min.js"></script>
    <script>
        Vue.component('modal', {
            template: '#modal-template'
        })


        var app = new Vue({
            delimiters: ['[[', ']]'],
            el: '#app',
            data() {
                return {
                    paypal: {
                        sandbox: 'Ab1Sz1kGg_pToL-VqcaNqUh1C4obLl11btkrD3nShf8FadP5sDn47sNiLVA7mHeWQKN9Fn14tMorYSag',
                        production: 'Aa2EMwpfZC-RkwuYd5FjEsuw5XOkYVmTk3K4GTJ1kTcMTuC5J2yV0mjhlua6mJg7Uf26YzPrMaCcixPT'
                    },
                    aStyle: {
                        label: 'checkout',
                        size: 'medium',
                        shape: 'rect',
                        color: 'blue',
                        tagline: 'false'
                    },
                    showModal: false,
                    escortCost: 10.00,
                    riderCost: 70.00,
                    amountStr: '0.00',
                    formList: [],
                    count: 0,
                    vue_form: "",
                    formIsValid: 'False',
                    paymentComplete: 'False',
                    formerrors: {},
                    formSuccess: '',
                    payment_cancelled: 'False'
                }
            },

            methods:
                {
                    the3DayMethod: function () {
                        let app = this
                        app.formSuccess = ''
                        var object = {}
                        forms = document.getElementById('feedbackform')

                        var formData = new FormData(forms),
                            result = {};
                        for (var entry of formData.entries()) {
                            result[entry[0]] = entry[1];
                        }
                        data = JSON.stringify(result)
                        console.log('called the the3DayMethod')
                        axios.post("{% url 'error_checking' %}",
                            data,
                            {
                                headers:
                                    {
                                        'X-CSRFToken': '{{ csrf_token }}',
                                    }
                            }
                        )
                            .then(function (response) {
                                app.formerrors = response.data.errors
                                app.formSuccess = response.data.success
                                console.log(app.formSuccess)
                            })
                    },

                    totalCost: function () {
                        let total_rider_classes = document.querySelectorAll('select[id*="rider_class"]')
                        let total = 0
                        let allRiderTypes = []

                        for (let i = 0; i < total_rider_classes.length; i++) {
                            allRiderTypes.push(total_rider_classes[i].value)
                        }

                        for (let i = 0; i < allRiderTypes.length; i++) {
                            if (allRiderTypes[i] !== 'Escort Rider') {
                                total += this.riderCost

                            } else {
                                total += this.escortCost
                            }
                        }
                        console.log(total)
                        this.amountStr = String(total.toFixed(2))

                    },

                    addForm: function () {
                        this.count++
                        let form_count = this.count
                        form_count++

                        let formID = 'id_form-' + this.count
                        incremented_form = this.vue_form.replace(/form-\d/g, 'form-' + this.count)
                        this.formList.push(incremented_form)
                        this.$nextTick(() => {
                            let total_forms = document.getElementsByName('form-TOTAL_FORMS').forEach
                            (function (ele, idx) {
                                ele.value = form_count
                            })
                        })
                    },

                    delForm: function () {
                        if (this.count != 0) {
                            this.count--
                            let form_count = this.count
                            form_count++

                            let formID = 'id_form-' + this.count
                            this.formList.pop()
                            this.$nextTick(() => {
                                let total_forms = document.getElementsByName('form-TOTAL_FORMS').forEach
                                (function (ele, idx) {
                                    ele.value = form_count
                                })
                            })
                        }
                        else return
                    },

                    formID: function () {
                        let formID = 'id_form-' + this.count
                        console.log(formID)
                        this.delForm()
                    },

                    add_rider_type: function () {
                        console.log('in the foo')
                        this.paypalItems.push({"name": ""})
                        console.log(this.paypalItems)
                    },

                    paymentAuthorized: function (data) {
                        console.log('The payment was authorized')
                        console.log(data)
                    },
                    paymentCompleted: function (data) {
                        console.log('The payment was completed')
                        this.paymentComplete = 'True'
                        console.log(this.paymentComplete)
                        console.log('Try and get a form submition off')


                    },
                    paymentCancelled: function (data) {
                        this.payment_cancelled = 'False'
                        console.log('The payment was declined or cancled, please try again')
                        console.log(data)
                        this.payment_cancelled = 'True'

                    },

                    select_change: function (e) {
                        var id = e.id
                        document.getElementById(id).onchange = function (e) {
                            console.log('Something happened')
                            totalCost()
                        }

                    }


                },


            mounted:

                function () {
                    let app = this

                    axios.post("{% url 'event_formset' %}",
                        {processData: false, contentType: false, event: '{{event}}'},
                        {
                            headers:
                                {
                                    'X-CSRFToken': '{{ csrf_token }}',
                                    'event': '{{ event }}',
                                }
                        }
                    )

                        .then(function (response) {
                            app.vue_form = response.data.formset.replace(/rider_class" /g, 'rider_class" oninput="select_change(this)"')
                            app.formList.push(app.vue_form)
                            app.riderCost = Number(response.data.reg_rider_cost)
                            app.escortCost = Number(response.data.escort_rider_cost)
                        })
                },

        })

    </script>
    <script>
        function select_change(e) {
            var id = e.id
            document.getElementById(id).onchange = function (e) {
                app.totalCost()
            }

        }

    </script>
    <script type="text/x-template" id="modal-template">
        <transition name="modal">
            <div class="modal-mask">
                <div class="modal-wrapper">
                    <div class="modal-container">

                        <div class="modal-header">
                            <slot name="header">
                                default header
                            </slot>
                        </div>

                        <div class="modal-body">
                            <slot name="body">
                                default body
                            </slot>
                        </div>

                        <div class="modal-footer">
                            <slot name="footer">
                                default footer
                                <button class="modal-default-button" @click="$emit('close')">
                                    OK
                                </button>
                            </slot>
                        </div>
                    </div>
                </div>
            </div>
        </transition>
    </script>

    <script>
        window.onscroll = function () {
            myFunction()
        };

        var header = document.getElementById("myHeader");
        var sticky = header.offsetTop;
        var jummarg = document.getElementById("jumbotron")

        function myFunction() {
            if (window.pageYOffset > sticky) {
                header.classList.add("sticky");
                jummarg.classList.add('margin_100')
            } else {
                header.classList.remove("sticky");
                jummarg.classList.remove('margin_100')

            }
        }
    </script>


{% endblock %}


