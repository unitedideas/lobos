{% extends 'base.html' %}
{% load static %}

<head>
    {% block head %}

        <title>Lobos Merch</title>

        <link rel="stylesheet" href='{% static "events/merchStyle.css" %}' type="text/css">

        <script language="javascript" type="text/javascript">
            function isIE() {
                const ua = navigator.userAgent;
                /* MSIE used to detect old browsers and Trident used to newer ones*/
                const is_ie = ua.indexOf("MSIE ") > -1 || ua.indexOf("Trident/") > -1;

                return is_ie;
            }

            /* Create an alert to show if the browser is IE or not */
            if (isIE()) {
                alert('InternetExplorer is not supported for registration on this site.\nPlease use Chrome, Edge, Firefox or Safari.');
            }

            window.onload = isIE();
        </script>
        <script type='text/javascript'>
            var json_args = {{ json_args|safe }};
        </script>
    {% endblock %}
</head>

{% block body %}
    <div id="app">
        <br>
        <div class="container">
            <div class="jumbotron">
                {{ args }}
                <h1>Lobos Events Merchandise</h1>
                <div class=barBreak></div>
                {% csrf_token %}
                {% for key, value in args.merch.items %}
                    <div class="merchSection">
                        <div class="merchImage">
                            <h2>{{ value.0.merchandise_name }}</h2>
                            {% if value.0.item_image %}
                                <img class="productImage" src="{% static value.0.item_image %}">
                            {% else %}
                                <h3>No product image available</h3>
                            {% endif %}
                        </div>
                        <div class="description">
                            <h3>{{ value.0.description }}</h3>
                        </div>
                    </div>
                    <table>
                        <tbody>
                        <tr>
                            <td>
                                <select id="select_{{ value.0.id }}" class="{{ value.0.id }}"
                                        @change="maxInput({{ value.0.id }})">
                                    {% for size, qty in value.1.items %}
                                        {% if qty <= 0 %}
                                            <option disabled>[[sizeTextChange('{{ size }}')]] -
                                                Sold Out
                                            </option>
                                        {% else %}
                                            <option value="{{ size }}">
                                                [[sizeTextChange('{{ size }}')]]
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <h3>Price: {{ value.0.sale_price }}</h3>
                            </td>
                            <td>
                                <input id="input_{{ value.0.id }}" class="{{ value.0.id }}" type="number" step="1"
                                       min="1" max="" value="1">
                            </td>
                            <td>
                                <div type="button" class="btn btn-primary"
                                     v-on:click="add_to_cart({{ value.0.id }})">Add Item
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <div class=barBreak></div>
                {% endfor %}
                <div>
                    <div v-if="cartlist.length > 0">
                        <h3>Your Cart:</h3>
                        <div>
                            <div v-for="(item, index) in cartlist">
                                <div class="col-sm-6">
                                    <div class="btn btn-primary" v-on:click='remove_from_cart(index)'>Remove</div>
                                </div>
                                <div class="col-sm-6">
                                    <h4>[[item.qty]] [[item.size]] [[item.item]]</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-if="merchTotal != 0">
                        <h3>Merchendise: [[merchTotal]]</h3>
                    </div>
                    <h3>Total: [[totalStr]]</h3>
                </div>
                <div v-show="showPayPal">
                    <paypal-checkout :amount='totalStr' currency="USD" :button-style="aStyle" :client="paypal"
                                     env="production" v-on:payment-authorized="paymentAuthorized"
                                     v-on:payment-completed="paymentCompleted"
                                     v-on:payment-cancelled="paymentCancelled">
                    </paypal-checkout>
                </div>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/vue-paypal-checkout/dist/vue-paypal-checkout.min.js"></script>

    <script>
        var app = new Vue({
            delimiters: ['[[', ']]'],
            el: '#app',
            data: function () {
                return {
                    paypal: {
                        sandbox: 'AYgwz1PZCp41wgIFot5Yg4e8qtx3uVzxxIFOyul4r8GIvW87mymJ7_khNL_F3L3XlBEasHbjncJ7485W',
                        production: 'AS_Jx2PoYa86AlHKjRhEff5F5jE_EEZquzJ_uaqxQHEuhU2MtUilTqbGuBxHwDpQ8O_giK9r-LQDdx_h'
                    },
                    aStyle: {
                        label: 'checkout',
                        size: 'large',
                        shape: 'rect',
                        color: 'blue',
                        tagline: 'false'
                    },
                    json_args:json_args,
                    inCartList: {},
                    cartlist: [],
                    merchTotal: 0,
                    regTotal: 0.00,
                    totalStr: "0.00",
                    showPayPal: true,
                }

            },
            watch: {
                cartlist() {
                    let count = 0
                    let cost = 0
                    for (item in this.cartlist) {
                        let itemcost = 0
                        let merchtot = 0
                        itemcost = this.cartlist[item].qty * this.cartlist[item].price
                        cost += itemcost
                    }
                    this.merchTotal = cost.toFixed(2)
                    this.totalStr = String((Number(this.merchTotal) + Number(this.regTotal)).toFixed(2))

                },
                regTotal() {
                    this.totalStr = String((Number(this.merchTotal) + Number(this.regTotal)).toFixed(2))
                },
            },
            methods: {
                maxInput(itemId) {
                    const selectedSize = document.getElementById('select_' + itemId).value
                    let item = 'item_'+itemId
                    console.log(item)
                    console.log(app.json_args.merch[item][1][selectedSize])
                    const inputField = document.getElementById('input_' + itemId)
                    inputField.max = app.json_args.merch[item][1][selectedSize]
                    inputField.value = 1
                },

                add_to_cart(item_id) {
                    this.inCartList.id = item_id
                    let datas = document.getElementsByClassName(item_id)
                    this.inCartList.size = datas[0].value
                    this.inCartList.qty = Number(datas[1].value)
                    console.log(this.inCartList)
                },

                sizeTextChange(sizeString) {
                    return sizeString.toLowerCase().split('_').map(function (word) {
                        return word.replace(word[0], word[0].toUpperCase());
                    }).join(' ').replace(/Quantity Available/, '').replace(/x/g, 'X');
                },

                remove_from_cart(index) {
                    let count = 0
                    let merch_order = "", end
                    this.cartlist.splice(index, 1)
                    for (i in this.cartlist) {
                        merch_order += String(Object.values(this.cartlist[count])) + "\n"
                        count += 1
                    }
                    document.getElementById("id_form-0-merchandise_ordered").value = merch_order
                },
                paymentAuthorized(data) {
                    this.showPayPal = false
                },

                paymentCompleted(data) {
                    document.getElementById('modal_close_btn').style.display = "none"
                    this.paymentComplete = true
                },

                paymentCancelled(data) {
                    this.payment_cancelled = false
                    this.payment_cancelled = true
                    this.showPayPal = true
                },

            },

        });

        class Merch {
            constructor(itemName, itemPrice, size) {
                this.itemName = itemName
                this.itemPrice = itemPrice
                this.size = size
            }
        }

    </script>
{% endblock %}